name: Deploy Server

on:
  push:
    branches: [main]
    paths:
      - "packages/server/**"
      - "docker-compose.yml"
      - "package.json"
      - "pnpm-lock.yaml"
      - ".github/workflows/deploy-server.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_NAME: web-notification
      DEPLOY_PATH: /data/apps/web-notification

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          mkdir -p deploy-package

          # Docker 配置
          cp docker-compose.yml deploy-package/

          # 后端代码
          mkdir -p deploy-package/packages/server
          cp packages/server/Dockerfile deploy-package/packages/server/
          cp packages/server/docker-entrypoint.sh deploy-package/packages/server/
          cp packages/server/package.json deploy-package/packages/server/
          cp packages/server/tsconfig.json deploy-package/packages/server/ 2>/dev/null || true
          cp -r packages/server/src deploy-package/packages/server/
          cp -r packages/server/prisma deploy-package/packages/server/ 2>/dev/null || true

          # 根目录配置
          cp package.json deploy-package/
          cp pnpm-lock.yaml deploy-package/
          cp pnpm-workspace.yaml deploy-package/

          # 打包
          tar -czvf server.tar.gz -C deploy-package .

      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          source: "server.tar.gz"
          target: "${{ env.DEPLOY_PATH }}"

      - name: Build and start container
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            cd ${{ env.DEPLOY_PATH }}

            # 解压
            rm -rf deploy.bak
            [ -d deploy ] && mv deploy deploy.bak
            mkdir -p deploy
            tar -xzf server.tar.gz -C deploy
            rm -f server.tar.gz

            # 环境变量（首次部署需手动配置）
            if [ ! -f .env ]; then
              echo "WARNING: .env file not found!"
              echo "Please create ${{ env.DEPLOY_PATH }}/.env with required variables"
              exit 1
            fi

            # 构建并启动
            cd deploy
            docker compose build
            docker compose up -d

            echo "Server deployed successfully!"
